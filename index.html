<!-- index.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Churrasco Eng em Forma√ß√£o</title>
  <style>
  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    padding: 0;
    background-color: #121212;
    color: #e0e0e0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
  }

  .container {
    max-width: 640px;
    margin: 0 auto;
    padding: 24px;
  }

  header img {
    width: 100%;
    height: auto;
    border-radius: 12px;
    box-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
  }

  h1.title {
    text-align: center;
    margin: 20px 0 10px;
    font-size: 1.8rem;
    color: #ffffff;
  }

  .event-info-text {
    background-color: #1e1e1e;
    padding: 16px;
    border-radius: 10px;
    margin: 20px 0;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
  }

  .info {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    margin-bottom: 8px;
  }

  a.add-calendar {
    color: #4dabf7;
    text-decoration: none;
    font-weight: 600;
    margin-top: 10px;
    display: inline-block;
  }
  * {
  box-sizing: border-box;
}


  a.add-calendar:hover {
    text-decoration: underline;
  }

  .location, .description {
    margin: 10px 0;
    color: #ccc;
  }

  .description {
    background-color: #1c1c1c;
    padding: 20px;
    border-radius: 10px;
    font-size: 0.95rem;
    box-shadow: inset 0 0 8px rgba(255, 255, 255, 0.03);
  }

  .buy-btn {
    display: block;
    width: 100%;
    padding: 14px;
    font-size: 1rem;
    font-weight: 700;
    color: white;
    background-color: #4dabf7;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 24px;
    transition: background-color 0.3s ease;
  }

  .voltar-btn {
  background-color: #333;
  color: #fff;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 10px;
  transition: background-color 0.3s ease;
}

.voltar-btn:hover {
  background-color: #555;
}

.ingresso-box {
  background-color: #1f1f1f;
  border: 1px solid #333;
  border-radius: 10px;
  padding: 16px 20px;
  margin-bottom: 20px;
  box-shadow: 0 0 4px rgba(255, 255, 255, 0.03);
}

.ingresso-box h3 {
  color: #90cdf4;
  margin-top: 0;
  margin-bottom: 12px;
}

.ingresso-box label {
  display: block;
  margin-bottom: 4px;
  font-weight: 600;
}

.ingresso-box input,
.ingresso-box select {
  width: 100%;
  padding: 10px 12px;
  margin-bottom: 14px;
  border-radius: 6px;
  border: 1px solid #444;
  background-color: #222;
  color: #eee;
  font-size: 1rem;
  font-weight: 500;
}


  label {
    font-weight: 600;
    display: block;
    margin-top: 10px;
    margin-bottom: 4px;
  }

  input, select {
    width: 100%;
    padding: 10px 14px;
    border-radius: 6px;
    border: 1px solid #444;
    background-color: #222;
    color: #eee;
    font-size: 1rem;
    font-weight: 500;
    margin-bottom: 12px;
  }

  input:focus, select:focus {
    outline: none;
    border-color: #4dabf7;
    background-color: #2a2a2a;
  }

  .resumo-box, .pix-box {
    background-color: #1c1c1c;
    border: 1px solid #333;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 20px;
    color: #ccc;
    box-shadow: 0 0 6px rgba(255, 255, 255, 0.04);
  }

  .resumo-box p, .pix-box p {
    margin: 6px 0;
    align-items: center;
  }

  hr {
    border: none;
    border-top: 1px solid #444;
    margin: 12px 0;
  }

  button#continue-btn, button#submit-btn, button#confirmar-btn {
    width: 100%;
    margin-top: 20px;
    padding: 12px;
    border: none;
    background-color: #4dabf7;
    color: white;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  button:hover {
    background-color: #339af0;
  }

  #form-pagamento {
    display: none;
  }

  @media screen and (max-width: 600px) {
    .container {
      padding: 16px;
    }
  }
</style>

</head>
<body>
  <div class="container" id="main-container">

    <!-- P√°gina Inicial -->
    <div id="inicio">
      <header>
        <img src="image/banner.jpeg" alt="Churrasco Eng em Forma√ß√£o Banner" />
      </header>
      <h1 class="title">Churrasco Eng em Forma√ß√£o</h1>
      <div class="event-info-text">
        <div class="info"><span>üìÖ</span> 23/08/2025</div>
        <div class="info"><span>‚è∞</span> 10:30</div>
        <a href="#" class="add-calendar" id="google-calendar-link">Adicionar ao calend√°rio</a>
        <div class="location">
          <p><strong>Rua Em√≠lio Roli, 200</strong></p>
          <p>Vila Gomes Cardim, Ourinhos ‚Äì SP</p>
        </div>
      </div>
      <div class="description">
        <p><strong>Descri√ß√£o do evento</strong></p>
        <p><strong>Descri√ß√£o do evento</strong></p>
        <p>
          Chegou a hora de garantir o seu ingresso pro nosso CHURRASCO ENG EM FORMA√á√ÉO! üî•ü•©<br />
          Dia 23/08/2025 ‚Äì a partir das 10h30<br />
          üìç R. Em√≠lio Roli, 200 ‚Äì Vila Gomes Cardim, Ourinhos ‚Äì SP
        </p>
        <p>
          Preencha os campos abaixo com suas informa√ß√µes, escolha a quantidade e o tipo de ingresso desejado e garanta j√° sua presen√ßa nesse evento que vai marcar a nossa jornada rumo ao CREA! üéìüí•
        </p>
        <p>
          üìå Aten√ß√£o: Todos os ingressos precisam conter nome completo, CPF, data de nascimento e o tipo de ingresso. As informa√ß√µes ser√£o usadas exatamente como preenchidas!
        </p>
        <p>
          üéü Tipos de ingresso:<br />
          Ingresso 1 ‚Äì Adulto com bebida alco√≥lica inclusa: R$ 90,00<br />
          Ingresso 2 ‚Äì Adulto sem bebida alco√≥lica: R$ 70,00<br />
          Ingresso 3 ‚Äì Crian√ßa: R$ 60,00
        </p>
        <p>
          üßä Quem quiser levar sua bebida e cooler, fique √† vontade!<br />
          üçª Quem n√£o quiser se preocupar com nada, √© s√≥ garantir o ingresso completo!
        </p>
        <p>
          üìÜ Os ingressos ser√£o vendidos por lote ‚Äì n√£o perca o prazo!
        </p>
        <p>
          üí¨ Qualquer d√∫vida, chama a comiss√£o!<br />
          Agora √© s√≥ preencher, fazer o pix e se preparar pro melhor churras da engenharia! üí•
        </p>

      </div>
      <button class="buy-btn" id="btn-comprar">COMPRAR</button>
    </div>

    <!-- Formul√°rio de Compra -->
    <div id="form-compra" style="display:none;">
      <h1 class="title">Compra de Ingressos</h1>
      <label for="quantidade">Quantidade de ingressos:</label>
      <input type="number" id="quantidade" min="1" max="10" value="1" required />
      <button id="continue-btn">Continuar</button>
      <form id="formulario" style="display:none;">
        <div id="ingressos"></div>
        <button type="submit" id="submit-btn">Finalizar Compra</button>
        <button type="button" class="voltar-btn" id="voltar-btn">‚Üê Voltar</button>
      </form>
    </div>

    <!-- Fechamento -->
    <div id="resumo-final" style="display:none;">
      <h1 class="title">Fechamento de Carrinho</h1>
      <div class="resumo-box" id="detalhes-resumo"></div>
      <div class="pix-box">
        <p><strong>Pagamento via Pix</strong></p>
        <p>Chave Pix: (14)997969064</p>
        <p>Nome do recebedor: Pedro Henrique Sencio</p>
        <div id="resultado"></div>

      </div>
      <div>
        <input type="file" id="comprovante-pix"/>
      </div>
      <button class="buy-btn" id="confirmar-btn">Confirmar Compra</button>
      <button type="button" class="voltar-btn" id="voltar-btn">‚Üê Voltar</button>
    </div>

  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <script>
  // Fun√ß√£o para validar CPF
    function validarCPF(cpf) {
      cpf = cpf.replace(/[^\d]+/g, '');

      if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;

      let soma = 0;
      for (let i = 0; i < 9; i++) {
        soma += parseInt(cpf.charAt(i)) * (10 - i);
      }

      let resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(9))) return false;

      soma = 0;
      for (let i = 0; i < 10; i++) {
        soma += parseInt(cpf.charAt(i)) * (11 - i);
      }

      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;

      return resto === parseInt(cpf.charAt(10));
    }

    document.getElementById('form-compra').addEventListener('submit', async function(e) {
      e.preventDefault();

      const qtd = parseInt(document.getElementById('quantidade').value);
      let valorTotal = 0;
      const nome = document.getElementById('nome_1').value.trim(); // Usa o nome do 1¬∫ ingresso
      const cpf = document.getElementById('cpf_1').value.trim();   // Usa o CPF do 1¬∫ ingresso

  for (let i = 1; i <= qtd; i++) {
    const tipo = document.getElementById(`tipo_${i}`).value;
    if (tipo === "1") valorTotal += 90;
    else if (tipo === "2") valorTotal += 70;
    else if (tipo === "3") valorTotal += 60;
  }

  console.log("Valor total calculado:", valorTotal); // Log para depura√ß√£o

  const dados = {
    nome,
    cpf,
    valor: valorTotal
  };


      const resposta = await fetch('https://churrasco-uawh.onrender.com/gerar-pix', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dados)
      });

      const json = await resposta.json();

      document.getElementById('resultado').innerHTML = `
        <h3>Use o Pix abaixo:</h3>
        <img src="data:image/png;base64,${json.qr_code_base64}" width="300"><br><br>
        <strong>Copia e Cola:</strong><br>
        <textarea style="width:300px; height:80px">${json.qr_code}</textarea>
      `;
    });
    // Mostrar formul√°rio
    document.getElementById('btn-comprar').addEventListener('click', () => {
      document.getElementById('inicio').style.display = 'none';
      document.getElementById('form-compra').style.display = 'block';
    });

    // Gerar campos
    document.getElementById('continue-btn').addEventListener('click', () => {
      const qtd = parseInt(document.getElementById('quantidade').value);
      if (!qtd || qtd < 1 || qtd > 10) {
        alert('Informe uma quantidade v√°lida entre 1 e 10.');
        return;
      }
      const container = document.getElementById('ingressos');
      container.innerHTML = '';
      for (let i = 1; i <= qtd; i++) {
        container.innerHTML += `
          <div class="ingresso-box">
            <h3>Ingresso ${i}</h3>
            <label>Nome completo:</label>
            <input type="text" id="nome_${i}" required />
            <label>CPF:</label>
            <input type="text" id="cpf_${i}" required />
            <label>Data de nascimento:</label>
            <input type="date" id="dtnasc_${i}" required />
            <label>Tipo de ingresso:</label>
            <select id="tipo_${i}" required>
              <option value="">Selecione</option>
              <option value="1">Adulto (com bebida) - R$90</option>
              <option value="2">Adulto (sem bebida) - R$70</option>
              <option value="3">Crian√ßa - R$60</option>
            </select>
          </div>`;
      }
      document.getElementById('formulario').style.display = 'block';
    });

    let idCompraGlobal = ''; // Define fora de qualquer escopo de fun√ß√£o

    // Finalizar compra e exibir resumo
    document.getElementById('formulario').addEventListener('submit', async function (e) {
      e.preventDefault();
      const qtd = parseInt(document.getElementById('quantidade').value);
      let total = 0;
      let html = '';

      idCompraGlobal = 'COMPRA-' + Date.now(); // Gera o ID global

      const dados = [];
      for (let i = 1; i <= qtd; i++) {
        const nome = document.getElementById(`nome_${i}`).value.trim();
        const cpf = document.getElementById(`cpf_${i}`).value.trim().replace(/\D/g, '');
        const nasc = document.getElementById(`dtnasc_${i}`).value;
        const tipo = document.getElementById(`tipo_${i}`).value;
        const tipoTexto = document.getElementById(`tipo_${i}`).options[document.getElementById(`tipo_${i}`).selectedIndex].text;

        if (!validarCPF(cpf)) {
          alert(`CPF inv√°lido no ingresso ${i}`);
          return;
        }

        dados.push({ nome, cpf, nascimento: nasc, tipo, status_pagamento: 'Pendente', id_compra: idCompraGlobal });

        const valor = tipo === "Adulto (com bebida) - R$90" ? 90 : tipo === "Adulto (sem bebida) - R$70" ? 70 : 60;
        total += valor;
        html += `<p><strong>Ingresso ${i}:</strong> ${tipoTexto}<br>Nome: ${nome}<br>CPF: ${cpf}<br>Nasc: ${nasc}<br>Valor: R$${valor}</p><hr>`;
      }
      html += `<p><strong>Total: R$${total}</strong></p>`;
      document.getElementById('detalhes-resumo').innerHTML = html;
      document.getElementById('form-compra').style.display = 'none';
      document.getElementById('resumo-final').style.display = 'block';

      // Requisi√ß√£o para gerar QR Code Pix
      try {
        const { nome, cpf, tipo } = dados[0];
        const sobrenome = document.getElementById('sobrenome_1')?.value.trim() || '';

        const paymentResponse = await fetch('https://churrasco-uawh.onrender.com/gerar-pix', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            nome,
            sobrenome, // novo campo
            cpf,
            valor: total,
            id_compra: idCompraGlobal,
            tipo
          }),
        });

        if (!paymentResponse.ok) {
          const errorText = await paymentResponse.text();
          throw new Error("Erro ao gerar Pix: " + errorText);
        }

        const data = await paymentResponse.json();

        if (!data.qr_code_base64) {
          throw new Error("QR Code n√£o gerado. Verifique o CPF ou credenciais.");
        }

        // Adiciona o paymentId √† lista de dados
        dados.forEach(d => d.payment_id = data.payment_id);

        const pixBox = document.querySelector('.pix-box');
        pixBox.innerHTML = `
          <p><strong>Pagamento via Pix</strong></p>
          <img src="data:image/png;base64,${data.qr_code_base64}" alt="QR Code para pagamento via Pix" width="300" /><br><br>
          <strong>C√≥digo Copia e Cola:</strong><br>
          <textarea style="width:300px; height:80px">${data.qr_code}</textarea>
        `;
      } catch (error) {
        console.error('Erro ao obter QR Code Pix:', error);
        const pixBox = document.querySelector('.pix-box');
        pixBox.innerHTML = '<p>Erro ao carregar o Pix. Tente novamente mais tarde.</p>';
      }
    });

    // Bot√£o voltar
    document.getElementById('voltar-btn').addEventListener('click', () => {
      document.getElementById('resumo-final').style.display = 'none';
      document.getElementById('inicio').style.display = 'block';
    });

    // Adicionar ao calend√°rio (atualizado para Google Calendar)
    document.getElementById('google-calendar-link').addEventListener('click', (e) => {
      e.preventDefault();
      const startDate = '20250823T103000';
      const endDate = '20250823T183000';
      const title = encodeURIComponent('Churrasco Eng em Forma√ß√£o');
      const location = encodeURIComponent('Rua Em√≠lio Roli, 200, Vila Gomes Cardim, Ourinhos ‚Äì SP');
      const description = encodeURIComponent('Chegou a hora de garantir o seu ingresso pro nosso CHURRASCO ENG EM FORMA√á√ÉO!');

      const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startDate}/${endDate}&details=${description}&location=${location}`;

      window.open(googleCalendarUrl, '_blank');
    });

    document.getElementById('confirmar-btn').addEventListener('click', () => {

      let msg = `‚úÖ Compra confirmada!\n\n`;
      cond = document.getElementById('comprovante-pix').files.length > 0;

      if (cond) {
        msg += 'por favor, anexe o comprovante de pagamento.\n\n';
      }
      
      dados.forEach((d, i) => {
        msg += `üéü Ingresso ${i + 1} - ${d.tipo}\nüë§ ${d.nome}\nüìÜ ${d.nascimento}\nüìé ${d.cpf}\n\n`;
      });

      const link = `https://wa.me/5514988348453?text=${encodeURIComponent(msg)}`;
      window.open(link, '_blank');
    });

    document.addEventListener('DOMContentLoaded', () => {
      const mp = new MercadoPago('APP_USR-47f95aa4-dfae-4982-9ec5-90d1c775f181', {
        locale: 'pt-BR'
      });

      const cardForm = mp.cardForm({
        amount: total, // valor din√¢mico baseado na compra
        autoMount: true,
        form: {
          id: 'form-id',
          cardholderName: {
            id: 'form-card-holder',
            placeholder: 'Titular do cart√£o'
          },
          cardNumber: {
            id: 'form-card-number',
            placeholder: 'N√∫mero do cart√£o'
          },
          expirationDate: {
            id: 'form-expiration-date',
            placeholder: 'MM/AA'
          },
          securityCode: {
            id: 'form-security-code',
            placeholder: 'CVV'
          }
        },
        callbacks: {
          onFormMounted: error => {
            if (error) console.warn('Erro ao montar o formul√°rio:', error);
          },
          onSubmit: async event => {
            event.preventDefault();
            const { deviceId, token, paymentMethodId, installments, issuerId, cardholderEmail, identificationNumber, identificationType } = cardForm.getCardFormData();

            const body = {
              token,
              transaction_amount: total, // valor din√¢mico baseado na compra
              payment_method_id: paymentMethodId,
              installments,
              issuer_id: issuerId,
              email: cardholderEmail,
              identificationNumber,
              identificationType,
              deviceId
            };

            const res = await fetch('https://churrasco-uawh.onrender.com/processar-pagamento', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });

            const resultado = await res.json();
            console.log(resultado);
          }
        }
      });
    });

    mp.getIdentificationTypes();

    const cardForm = mp.cardForm({
      amount: "100.00", // valor fixo ou din√¢mico
      autoMount: true,
      form: {
        id: "form-id",
        cardholderName: { id: "form-card-holder", placeholder: "Nome completo" },
        cardholderEmail: { id: "form-card-email", placeholder: "Email" },
        cardNumber: { id: "form-card-number", placeholder: "N√∫mero do cart√£o" },
        expirationDate: { id: "form-expiration-date", placeholder: "MM/AA" },
        securityCode: { id: "form-security-code", placeholder: "CVV" },
        installments: { id: "form-installments" },
        identificationType: { id: "form-doc-type" },
        identificationNumber: { id: "form-doc-number", placeholder: "CPF" },
        issuer: { id: "form-issuer" }
      },
      callbacks: {
        onFormMounted: error => {
          if (error) return console.warn("Erro ao montar o formul√°rio:", error);
        },
        onSubmit: async event => {
          event.preventDefault();

          const {
            token,
            paymentMethodId,
            issuerId,
            installments,
            identificationNumber,
            identificationType,
            cardholderEmail,
            deviceId
          } = cardForm.getCardFormData();

          try {
            const resposta = await fetch("https://churrasco-uawh.onrender.com/processar-pagamento", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                token,
                transaction_amount: 100.00, // ou valor real
                payment_method_id: paymentMethodId,
                installments,
                issuer_id: issuerId,
                email: cardholderEmail,
                identificationType,
                identificationNumber,
                deviceId
              })
            });

            const resultado = await resposta.json();

            document.getElementById("resultado-cartao").innerHTML = `
              <p><strong>Status:</strong> ${resultado.status}</p>
              <p><strong>Detalhe:</strong> ${resultado.status_detail}</p>
              <p><strong>ID:</strong> ${resultado.id}</p>
            `;
          } catch (err) {
            document.getElementById("resultado-cartao").innerHTML = `<p>Erro: ${err.message}</p>`;
          }
        }
      }
    });
  </script>
</body>
</html>
